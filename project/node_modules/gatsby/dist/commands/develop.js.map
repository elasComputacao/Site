{"version":3,"sources":["../../src/commands/develop.ts"],"names":["requireUncached","file","require","cache","resolve","e","doesConfigChangeRequireRestart","lastConfig","newConfig","replacer","_","v","RegExp","toString","oldConfigString","JSON","stringify","siteMetadata","newConfigString","getDebugPort","port","getDebugInfo","program","hasOwnProperty","inspect","break","inspectBrk","ControllableScript","constructor","script","debugInfo","start","args","tmpFileName","tmp","tmpNameSync","tmpdir","path","join","process","cwd","fs","outputFileSync","isRunning","push","execa","node","env","stdio","stop","signal","code","Error","kill","send","type","action","payload","Promise","on","removeAllListeners","undefined","onMessage","callback","onExit","msg","isRestarting","REGEX_IP","module","exports","parseInt","developProcessPath","message","exit","proxyPort","statusServerPort","developPort","all","INTERNAL_STATUS_PORT","https","reporter","panic","sslHost","host","test","ssl","name","caFile","certFile","keyFile","directory","proxy","targetPort","developProcess","unlocks","statusUnlock","developUnlock","sitePackageJson","sitePath","pid","lastRun","Date","now","data","console","error","concat","statusServer","http","createServer","listen","io","handleChildProcessIPC","serveSite","emit","socket","serveRestartingScreen","rootFile","files","watcher","chokidar","watch","filePath","basename","warn","dirtyFile","shutdownServices","_code","services","close","server","forEach","unlock","catch","then"],"mappings":"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","sourcesContent":["// NOTE(@mxstbr): Do not use the reporter in this file, as that has side-effects on import which break structured logging\nimport path from \"path\"\nimport http from \"http\"\nimport tmp from \"tmp\"\nimport { ChildProcess } from \"child_process\"\nimport execa from \"execa\"\nimport chokidar from \"chokidar\"\nimport getRandomPort from \"detect-port\"\nimport { detectPortInUseAndPrompt } from \"../utils/detect-port-in-use-and-prompt\"\nimport socket from \"socket.io\"\nimport fs from \"fs-extra\"\nimport onExit from \"signal-exit\"\nimport {\n  isCI,\n  slash,\n  createServiceLock,\n  getService,\n  updateSiteMetadata,\n  UnlockFn,\n} from \"gatsby-core-utils\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { getSslCert } from \"../utils/get-ssl-cert\"\nimport { startDevelopProxy } from \"../utils/develop-proxy\"\nimport { IProgram, IDebugInfo } from \"./types\"\n\n// Adapted from https://stackoverflow.com/a/16060619\nconst requireUncached = (file: string): any => {\n  try {\n    delete require.cache[require.resolve(file)]\n  } catch (e) {\n    return null\n  }\n\n  try {\n    return require(file)\n  } catch (e) {\n    return null\n  }\n}\n\n// Heuristics for gatsby-config.js, as not all changes to it require a full restart to take effect\nconst doesConfigChangeRequireRestart = (\n  lastConfig: Record<string, any>,\n  newConfig: Record<string, any>\n): boolean => {\n  // Ignore changes to siteMetadata\n  const replacer = (_, v): string | void => {\n    if (typeof v === `function` || v instanceof RegExp) {\n      return v.toString()\n    } else {\n      return v\n    }\n  }\n\n  const oldConfigString = JSON.stringify(\n    { ...lastConfig, siteMetadata: null },\n    replacer\n  )\n  const newConfigString = JSON.stringify(\n    { ...newConfig, siteMetadata: null },\n    replacer\n  )\n\n  if (oldConfigString === newConfigString) return false\n\n  return true\n}\n\n// Return a user-supplied port otherwise the default Node.js debugging port\nconst getDebugPort = (port?: number): number => port ?? 9229\n\nexport const getDebugInfo = (program: IProgram): IDebugInfo | null => {\n  if (program.hasOwnProperty(`inspect`)) {\n    return {\n      port: getDebugPort(program.inspect),\n      break: false,\n    }\n  } else if (program.hasOwnProperty(`inspectBrk`)) {\n    return {\n      port: getDebugPort(program.inspectBrk),\n      break: true,\n    }\n  } else {\n    return null\n  }\n}\n\nclass ControllableScript {\n  private process?: ChildProcess\n  private script\n  private debugInfo: IDebugInfo | null\n  public isRunning\n  constructor(script, debugInfo: IDebugInfo | null) {\n    this.script = script\n    this.debugInfo = debugInfo\n  }\n  start(): void {\n    const args = []\n    const tmpFileName = tmp.tmpNameSync({\n      tmpdir: path.join(process.cwd(), `.cache`),\n    })\n    fs.outputFileSync(tmpFileName, this.script)\n    this.isRunning = true\n    // Passing --inspect isn't necessary for the child process to launch a port but it allows some editors to automatically attach\n    if (this.debugInfo) {\n      if (this.debugInfo.break) {\n        args.push(`--inspect-brk=${this.debugInfo.port}`)\n      } else {\n        args.push(`--inspect=${this.debugInfo.port}`)\n      }\n    }\n\n    this.process = execa.node(tmpFileName, args, {\n      env: process.env,\n      stdio: [`inherit`, `inherit`, `inherit`, `ipc`],\n    })\n  }\n  async stop(\n    signal: NodeJS.Signals | null = null,\n    code?: number\n  ): Promise<void> {\n    if (!this.process) {\n      throw new Error(`Trying to stop the process before starting it`)\n    }\n\n    this.isRunning = false\n    if (signal) {\n      this.process.kill(signal)\n    } else {\n      this.process.send({\n        type: `COMMAND`,\n        action: {\n          type: `EXIT`,\n          payload: code,\n        },\n      })\n    }\n\n    return new Promise(resolve => {\n      if (!this.process) {\n        throw new Error(`Trying to stop the process before starting it`)\n      }\n\n      this.process.on(`exit`, () => {\n        if (this.process) {\n          this.process.removeAllListeners()\n        }\n        this.process = undefined\n        resolve()\n      })\n    })\n  }\n  onMessage(callback: (msg: any) => void): void {\n    if (!this.process) {\n      throw new Error(`Trying to attach message handler before process started`)\n    }\n    this.process.on(`message`, callback)\n  }\n  onExit(\n    callback: (code: number | null, signal: NodeJS.Signals | null) => void\n  ): void {\n    if (!this.process) {\n      throw new Error(`Trying to attach exit handler before process started`)\n    }\n    this.process.on(`exit`, callback)\n  }\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  send(msg: any): void {\n    if (!this.process) {\n      throw new Error(`Trying to send a message before process started`)\n    }\n\n    this.process.send(msg)\n  }\n}\n\nlet isRestarting\n\n// checks if a string is a valid ip\nconst REGEX_IP = /^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9]?[0-9])$/\n\nmodule.exports = async (program: IProgram): Promise<void> => {\n  // In some cases, port can actually be a string. But our codebase is expecting it to be a number.\n  // So we want to early just force it to a number to ensure we always act on a correct type.\n  program.port = parseInt(program.port + ``, 10)\n  const developProcessPath = slash(require.resolve(`./develop-process`))\n\n  try {\n    program.port = await detectPortInUseAndPrompt(program.port)\n  } catch (e) {\n    if (e.message === `USER_REJECTED`) {\n      process.exit(0)\n    }\n\n    throw e\n  }\n\n  // Run the actual develop server on a random port, and the proxy on the program port\n  // which users will access\n  const proxyPort = program.port\n  const debugInfo = getDebugInfo(program)\n\n  // INTERNAL_STATUS_PORT allows for setting the websocket port used for monitoring\n  // when the browser should prompt the user to restart the develop process.\n  // This port is randomized by default and in most cases should never be required to configure.\n  // It is exposed for environments where port access needs to be explicit, such as with Docker.\n  // As the port is meant for internal usage only, any attempt to interface with features\n  // it exposes via third-party software is not supported.\n  const [statusServerPort, developPort] = await Promise.all([\n    getRandomPort(process.env.INTERNAL_STATUS_PORT),\n    getRandomPort(),\n  ])\n\n  // In order to enable custom ssl, --cert-file --key-file and -https flags must all be\n  // used together\n  if ((program[`cert-file`] || program[`key-file`]) && !program.https) {\n    reporter.panic(\n      `for custom ssl --https, --cert-file, and --key-file must be used together`\n    )\n  }\n\n  // Check if https is enabled, then create or get SSL cert.\n  // Certs are named 'devcert' and issued to the host.\n  // NOTE(@mxstbr): We mutate program.ssl _after_ passing it\n  // to the develop process controllable script above because\n  // that would mean we double SSL browser => proxy => server\n  if (program.https) {\n    const sslHost =\n      program.host === `0.0.0.0` || program.host === `::`\n        ? `localhost`\n        : program.host\n\n    if (REGEX_IP.test(sslHost)) {\n      reporter.panic(\n        `You're trying to generate a ssl certificate for an IP (${sslHost}). Please use a hostname instead.`\n      )\n    }\n\n    const ssl = await getSslCert({\n      name: sslHost,\n      caFile: program[`ca-file`],\n      certFile: program[`cert-file`],\n      keyFile: program[`key-file`],\n      directory: program.directory,\n    })\n\n    if (ssl) {\n      program.ssl = ssl\n    }\n  }\n\n  // NOTE(@mxstbr): We need to start the develop proxy before the develop process to ensure\n  // codesandbox detects the right port to expose by default\n  const proxy = startDevelopProxy({\n    proxyPort: proxyPort,\n    targetPort: developPort,\n    program,\n  })\n\n  const developProcess = new ControllableScript(\n    `\n    const cmd = require(${JSON.stringify(developProcessPath)});\n    const args = ${JSON.stringify({\n      ...program,\n      port: developPort,\n      proxyPort,\n      // Don't pass SSL options down to the develop process, it should always use HTTP\n      ssl: null,\n      debugInfo,\n    })};\n    cmd(args);\n  `,\n    debugInfo\n  )\n\n  let unlocks: Array<UnlockFn> = []\n  if (!isCI()) {\n    const statusUnlock = await createServiceLock(\n      program.directory,\n      `developstatusserver`,\n      {\n        port: statusServerPort,\n      }\n    )\n    const developUnlock = await createServiceLock(\n      program.directory,\n      `developproxy`,\n      {\n        port: proxyPort,\n      }\n    )\n    await updateSiteMetadata({\n      name: program.sitePackageJson.name,\n      sitePath: program.directory,\n      pid: process.pid,\n      lastRun: Date.now(),\n    })\n\n    if (!statusUnlock || !developUnlock) {\n      const data = await getService(program.directory, `developproxy`)\n      const port = data?.port || 8000\n      console.error(\n        `Looks like develop for this site is already running, can you visit ${\n          program.ssl ? `https://` : `http://`\n        }://localhost:${port} ? If it is not, try again in five seconds!`\n      )\n      process.exit(1)\n    }\n\n    unlocks = unlocks.concat([statusUnlock, developUnlock])\n  }\n\n  const statusServer = http.createServer().listen(statusServerPort)\n  const io = socket(statusServer)\n\n  const handleChildProcessIPC = (msg): void => {\n    if (msg.type === `HEARTBEAT`) return\n    if (process.send) {\n      // Forward IPC\n      process.send(msg)\n    }\n\n    if (\n      msg.type === `LOG_ACTION` &&\n      msg.action.type === `SET_STATUS` &&\n      msg.action.payload === `SUCCESS`\n    ) {\n      proxy.serveSite()\n      io.emit(`develop:started`)\n    }\n  }\n\n  io.on(`connection`, socket => {\n    socket.on(`develop:restart`, async () => {\n      isRestarting = true\n      proxy.serveRestartingScreen()\n      io.emit(`develop:is-starting`)\n      await developProcess.stop()\n      developProcess.start()\n      developProcess.onMessage(handleChildProcessIPC)\n      isRestarting = false\n    })\n  })\n\n  developProcess.start()\n  developProcess.onMessage(handleChildProcessIPC)\n\n  // Plugins can call `process.exit` which would be sent to `develop-process` (child process)\n  // This needs to be propagated back to the parent process\n  developProcess.onExit(\n    (code: number | null, signal: NodeJS.Signals | null) => {\n      if (isRestarting) return\n      if (signal !== null) {\n        process.kill(process.pid, signal)\n        return\n      }\n      if (code !== null) {\n        process.exit(code)\n      }\n\n      // This should not happen:\n      // https://nodejs.org/api/child_process.html#child_process_event_exit\n      // The 'exit' event is emitted after the child process ends. If the process\n      // exited, code is the final exit code of the process, otherwise null.\n      // If the process terminated due to receipt of a signal, signal is the\n      // string name of the signal, otherwise null. One of the two will always be\n      // non - null.\n      //\n      // but just in case let do non-zero exit, because we are in situation\n      // we don't expect to be possible\n      process.exit(1)\n    }\n  )\n\n  const rootFile = (file: string): string => path.join(program.directory, file)\n\n  const files = [rootFile(`gatsby-config.js`), rootFile(`gatsby-node.js`)]\n  let lastConfig = requireUncached(rootFile(`gatsby-config.js`))\n  let watcher: chokidar.FSWatcher = null\n\n  if (!isCI()) {\n    watcher = chokidar.watch(files).on(`change`, filePath => {\n      const file = path.basename(filePath)\n\n      if (file === `gatsby-config.js`) {\n        const newConfig = requireUncached(rootFile(`gatsby-config.js`))\n\n        if (!doesConfigChangeRequireRestart(lastConfig, newConfig)) {\n          lastConfig = newConfig\n          return\n        }\n\n        lastConfig = newConfig\n      }\n\n      console.warn(\n        `develop process needs to be restarted to apply the changes to ${file}`\n      )\n      io.emit(`develop:needs-restart`, {\n        dirtyFile: file,\n      })\n    })\n  }\n\n  // route ipc messaging to the original develop process\n  process.on(`message`, msg => {\n    developProcess.send(msg)\n  })\n\n  process.on(`SIGINT`, async () => {\n    await shutdownServices(\n      {\n        developProcess,\n        unlocks,\n        statusServer,\n        proxy,\n        watcher,\n      },\n      `SIGINT`\n    )\n\n    process.exit(0)\n  })\n\n  process.on(`SIGTERM`, async () => {\n    await shutdownServices(\n      {\n        developProcess,\n        unlocks,\n        statusServer,\n        proxy,\n        watcher,\n      },\n      `SIGTERM`\n    )\n\n    process.exit(0)\n  })\n\n  onExit((_code, signal) => {\n    shutdownServices(\n      {\n        developProcess,\n        unlocks,\n        statusServer,\n        proxy,\n        watcher,\n      },\n      signal as NodeJS.Signals\n    )\n  })\n}\nfunction shutdownServices(\n  { statusServer, developProcess, proxy, unlocks, watcher },\n  signal: NodeJS.Signals\n): Promise<void> {\n  const services = [\n    developProcess.stop(signal),\n    watcher?.close(),\n    new Promise(resolve => statusServer.close(resolve)),\n    new Promise(resolve => proxy.server.close(resolve)),\n  ]\n\n  unlocks.forEach(unlock => {\n    services.push(unlock())\n  })\n\n  return Promise.all(services)\n    .catch(() => {})\n    .then(() => {})\n}\n"],"file":"develop.js"}